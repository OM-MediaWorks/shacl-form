var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{p as root,t as toNumber,q as isObject,u as browserExports,v as commonjsGlobal,k as reactExports,d as sh$1,e as shFrm,j as jsxRuntimeExports,I as Icon}from"./index-e7c84aa2.js";import{S as ShaclFormSingleEditorReact}from"./ShaclFormSingleEditorReact-6bfb81a0-b0c93fe4.js";import{s as sparql,a as sparqljsonParse,b as sparqlxmlParse,c as streamToString,l as lib,r as require$$0,i as isStream_1}from"./index-ccc0cdd1.js";import"./ShaclFormSingleEditor-bb2b982a-5cd3a643.js";import"./___vite-browser-external_commonjs-proxy-32c16fb2.js";var now=__name(function(){return root.Date.now()},"now");const now$1=now;var FUNC_ERROR_TEXT="Expected a function",nativeMax=Math.max,nativeMin=Math.min;function debounce(func,wait,options){var lastArgs,lastThis,maxWait,result,timerId,lastCallTime,lastInvokeTime=0,leading=!1,maxing=!1,trailing=!0;if(typeof func!="function")throw new TypeError(FUNC_ERROR_TEXT);wait=toNumber(wait)||0,isObject(options)&&(leading=!!options.leading,maxing="maxWait"in options,maxWait=maxing?nativeMax(toNumber(options.maxWait)||0,wait):maxWait,trailing="trailing"in options?!!options.trailing:trailing);function invokeFunc(time){var args=lastArgs,thisArg=lastThis;return lastArgs=lastThis=void 0,lastInvokeTime=time,result=func.apply(thisArg,args),result}__name(invokeFunc,"invokeFunc");function leadingEdge(time){return lastInvokeTime=time,timerId=setTimeout(timerExpired,wait),leading?invokeFunc(time):result}__name(leadingEdge,"leadingEdge");function remainingWait(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime,timeWaiting=wait-timeSinceLastCall;return maxing?nativeMin(timeWaiting,maxWait-timeSinceLastInvoke):timeWaiting}__name(remainingWait,"remainingWait");function shouldInvoke(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime;return lastCallTime===void 0||timeSinceLastCall>=wait||timeSinceLastCall<0||maxing&&timeSinceLastInvoke>=maxWait}__name(shouldInvoke,"shouldInvoke");function timerExpired(){var time=now$1();if(shouldInvoke(time))return trailingEdge(time);timerId=setTimeout(timerExpired,remainingWait(time))}__name(timerExpired,"timerExpired");function trailingEdge(time){return timerId=void 0,trailing&&lastArgs?invokeFunc(time):(lastArgs=lastThis=void 0,result)}__name(trailingEdge,"trailingEdge");function cancel(){timerId!==void 0&&clearTimeout(timerId),lastInvokeTime=0,lastArgs=lastCallTime=lastThis=timerId=void 0}__name(cancel,"cancel");function flush(){return timerId===void 0?result:trailingEdge(now$1())}__name(flush,"flush");function debounced(){var time=now$1(),isInvoking=shouldInvoke(time);if(lastArgs=arguments,lastThis=this,lastCallTime=time,isInvoking){if(timerId===void 0)return leadingEdge(lastCallTime);if(maxing)return clearTimeout(timerId),timerId=setTimeout(timerExpired,wait),invokeFunc(lastCallTime)}return timerId===void 0&&(timerId=setTimeout(timerExpired,wait)),result}return __name(debounced,"debounced"),debounced.cancel=cancel,debounced.flush=flush,debounced}__name(debounce,"debounce");var fetchSparqlEndpoint={},SparqlEndpointFetcher$1={};Object.defineProperty(SparqlEndpointFetcher$1,"__esModule",{value:!0});SparqlEndpointFetcher$1.SparqlEndpointFetcher=void 0;const abort_controller_1=browserExports,sparqljs_1=sparql,sparqljson_parse_1=sparqljsonParse,sparqlxml_parse_1=sparqlxmlParse,stringifyStream=streamToString,readable_web_to_node_stream_1=lib,n3=require$$0,isStream=isStream_1;class SparqlEndpointFetcher{constructor(args){args=args||{},this.method=args.method||"POST",this.additionalUrlParams=args.additionalUrlParams||new URLSearchParams,this.defaultHeaders=args.defaultHeaders||new Headers,this.fetchCb=args.fetch,this.sparqlJsonParser=new sparqljson_parse_1.SparqlJsonParser(args),this.sparqlXmlParser=new sparqlxml_parse_1.SparqlXmlParser(args),this.sparqlParsers={[SparqlEndpointFetcher.CONTENTTYPE_SPARQL_JSON]:{parseBooleanStream:sparqlResponseStream=>this.sparqlJsonParser.parseJsonBooleanStream(sparqlResponseStream),parseResultsStream:sparqlResponseStream=>this.sparqlJsonParser.parseJsonResultsStream(sparqlResponseStream)},[SparqlEndpointFetcher.CONTENTTYPE_SPARQL_XML]:{parseBooleanStream:sparqlResponseStream=>this.sparqlXmlParser.parseXmlBooleanStream(sparqlResponseStream),parseResultsStream:sparqlResponseStream=>this.sparqlXmlParser.parseXmlResultsStream(sparqlResponseStream)}},this.timeout=args.timeout}getQueryType(query){const parsedQuery=new sparqljs_1.Parser().parse(query);return parsedQuery.type==="query"?parsedQuery.queryType==="DESCRIBE"?"CONSTRUCT":parsedQuery.queryType:"UNKNOWN"}getUpdateTypes(query){const parsedQuery=new sparqljs_1.Parser().parse(query);if(parsedQuery.type==="update"){const operations={};for(const update of parsedQuery.updates)"type"in update?operations[update.type]=!0:operations[update.updateType]=!0;return operations}else return"UNKNOWN"}async fetchBindings(endpoint,query){const[contentType,responseStream]=await this.fetchRawStream(endpoint,query,SparqlEndpointFetcher.CONTENTTYPE_SPARQL),parser=this.sparqlParsers[contentType];if(!parser)throw new Error("Unknown SPARQL results content type: "+contentType);return parser.parseResultsStream(responseStream)}async fetchAsk(endpoint,query){const[contentType,responseStream]=await this.fetchRawStream(endpoint,query,SparqlEndpointFetcher.CONTENTTYPE_SPARQL),parser=this.sparqlParsers[contentType];if(!parser)throw new Error("Unknown SPARQL results content type: "+contentType);return parser.parseBooleanStream(responseStream)}async fetchTriples(endpoint,query){return(await this.fetchRawStream(endpoint,query,SparqlEndpointFetcher.CONTENTTYPE_TURTLE))[1].pipe(new n3.StreamParser({format:SparqlEndpointFetcher.CONTENTTYPE_TURTLE}))}async fetchUpdate(endpoint,query){const abortController=new abort_controller_1.default,defaultHeadersRaw={};this.defaultHeaders.forEach((value,key)=>{defaultHeadersRaw[key]=value});const init={method:"POST",headers:Object.assign(Object.assign({},defaultHeadersRaw),{"content-type":"application/sparql-update"}),body:query,signal:abortController.signal};await this.handleFetchCall(endpoint,init,{ignoreBody:!0}),abortController.abort()}async fetchRawStream(endpoint,query,acceptHeader){let url=this.method==="POST"?endpoint:endpoint+"?query="+encodeURIComponent(query);const headers=new Headers(this.defaultHeaders);let body;return headers.append("Accept",acceptHeader),this.method==="POST"?(headers.append("Content-Type","application/x-www-form-urlencoded"),body=new URLSearchParams,body.set("query",query),this.additionalUrlParams.forEach((value,key)=>{body.set(key,value)}),headers.append("Content-Length",body.toString().length.toString())):this.additionalUrlParams.toString()!==""&&(url+=`&${this.additionalUrlParams.toString()}`),this.handleFetchCall(url,{headers,method:this.method,body})}async handleFetchCall(url,init,options={}){let timeoutId;if(this.timeout){const controller=new abort_controller_1.default;init.signal=controller.signal,timeoutId=setTimeout(()=>controller.abort(),this.timeout)}const httpResponse=await(this.fetchCb||fetch)(url,init);clearTimeout(timeoutId);let responseStream;options.ignoreBody||(responseStream=isStream(httpResponse.body)?httpResponse.body:new readable_web_to_node_stream_1.ReadableWebToNodeStream(httpResponse.body));let contentType=httpResponse.headers.get("Content-Type")||"";if(contentType.indexOf(";")>0&&(contentType=contentType.substr(0,contentType.indexOf(";"))),!httpResponse.ok){const simpleUrl=/^[^?]*/u.exec(url)[0];let bodyString="empty response";throw responseStream&&(bodyString=await stringifyStream(responseStream)),new Error(`Invalid SPARQL endpoint response from ${simpleUrl} (HTTP status ${httpResponse.status}):
${bodyString}`)}return[contentType,responseStream]}}__name(SparqlEndpointFetcher,"SparqlEndpointFetcher");SparqlEndpointFetcher.CONTENTTYPE_SPARQL_JSON="application/sparql-results+json";SparqlEndpointFetcher.CONTENTTYPE_SPARQL_XML="application/sparql-results+xml";SparqlEndpointFetcher.CONTENTTYPE_SPARQL=`${SparqlEndpointFetcher.CONTENTTYPE_SPARQL_JSON};q=1.0,${SparqlEndpointFetcher.CONTENTTYPE_SPARQL_XML};q=0.7`;SparqlEndpointFetcher.CONTENTTYPE_TURTLE="text/turtle";SparqlEndpointFetcher$1.SparqlEndpointFetcher=SparqlEndpointFetcher;(function(exports){var __createBinding=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(o,m,k,k2){k2===void 0&&(k2=k);var desc=Object.getOwnPropertyDescriptor(m,k);(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable))&&(desc={enumerable:!0,get:function(){return m[k]}}),Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){k2===void 0&&(k2=k),o[k2]=m[k]}),__exportStar=commonjsGlobal&&commonjsGlobal.__exportStar||function(m,exports2){for(var p in m)p!=="default"&&!Object.prototype.hasOwnProperty.call(exports2,p)&&__createBinding(exports2,m,p)};Object.defineProperty(exports,"__esModule",{value:!0}),__exportStar(SparqlEndpointFetcher$1,exports)})(fetchSparqlEndpoint);var __defProp2=Object.defineProperty,__name2=__name((target,value)=>__defProp2(target,"name",{value,configurable:!0}),"__name");globalThis.process||(globalThis.process={});var _a;(_a=globalThis.process)!=null&&_a.nextTick||(globalThis.process.nextTick=function(callback,...args){globalThis.requestAnimationFrame?globalThis.requestAnimationFrame(()=>callback(...args)):setTimeout(()=>callback(...args))});const fetcher=__name2(async(endpoint,sparql2,callback)=>{new fetchSparqlEndpoint.SparqlEndpointFetcher().fetchBindings(endpoint,sparql2).then(bindingsStream=>bindingsStream.on("data",callback))},"fetcher"),debouncedFetcher=debounce(fetcher,300);class Reference extends ShaclFormSingleEditorReact{template(){const[searchTerm,setSearchTerm]=reactExports.useState(""),[results,setResults]=reactExports.useState([]),[value,setValue]=reactExports.useState(null),sparql2=this.shaclPointer.out([sh$1("select")]).value,endpoint=this.shaclPointer.out([shFrm("source")]).value;reactExports.useEffect(()=>{var _a2;if(!((_a2=this.value)!=null&&_a2.value))return;if(sessionStorage.getItem(this.value.value)){setValue(JSON.parse(sessionStorage.getItem(this.value.value)));return}const tokenizedSparql=sparql2.split(`
`).map(line=>line.includes("?searchTerm")?`VALUES ?uri { <${this.value.value}> }`:line).join(`
`);fetcher(endpoint,tokenizedSparql,setValue)},[]),reactExports.useEffect(()=>{if(searchTerm.length<4)return;const tokenizedSparql=sparql2.replaceAll("?searchTerm",`"""${searchTerm.split(" ").map(word=>`'${word}'`).join(" AND ")}"""`);setResults([]),debouncedFetcher(endpoint,tokenizedSparql,bindings=>{sessionStorage.setItem(bindings.uri.value,JSON.stringify(bindings)),results.push(bindings),setResults([...results])})},[searchTerm]);const[hasError,setHasError]=reactExports.useState([]);return jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[value?jsxRuntimeExports.jsxs("div",{className:"p-0 form-control align-items-center d-flex",title:value.uri.value,children:[value.image&&!hasError.includes(value.image.value)?jsxRuntimeExports.jsx("img",{onError:()=>setHasError([...hasError,value.image.value]),className:"image",src:`//wsrv.nl/?url=${value.image.value}&w=35&h=35&fit=cover&a=attention`}):jsxRuntimeExports.jsx("div",{className:"image fallback",style:{aspectRatio:1,background:"#eee"}}),jsxRuntimeExports.jsx("span",{className:"p-1 ps-2",children:value.label.value}),jsxRuntimeExports.jsx("a",{className:"ms-auto me-2",href:value.uri.value,target:"_blank",children:jsxRuntimeExports.jsx(Icon,{icon:"clarity:pop-out-line"})})]}):jsxRuntimeExports.jsx("input",{type:"search",placeholder:"Search",className:"form-control",value:searchTerm,onChange:event=>setSearchTerm(event.target.value)}),results.length?jsxRuntimeExports.jsx("div",{className:"list-group mt-3",children:results.map(result=>jsxRuntimeExports.jsxs("button",{onClick:()=>{this.value=this.df.namedNode(result.uri.value)},className:"p-0 list-group-item list-group-item-action d-flex",children:[result.image&&!hasError.includes(result.image.value)?jsxRuntimeExports.jsx("img",{onError:()=>setHasError([...hasError,result.image.value]),className:"image",src:`//wsrv.nl/?url=${result.image.value}&w=35&h=35&fit=cover&a=attention`}):jsxRuntimeExports.jsx("div",{className:"image fallback",style:{aspectRatio:1,background:"#eee"}}),jsxRuntimeExports.jsx("span",{className:"p-2",children:result.label.value})]},result.uri.value))}):null]})}}__name(Reference,"Reference");__name2(Reference,"Reference");export{Reference as default};
